<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="./css/view.min.css">
		<link rel="stylesheet" href="./css/base.css">
		<script src="./js/zepto_1.1.3.js"></script>
		<title>紫薇帝星展厅</title>
	</head>

	<body>
		<div class="playBtn"></div>
		<audio src="./js/music.mp3" id="audios" style="position: absolute;left: 99999999999999px;top: 999999999px;" loop="true"></audio>
		<div id="photosphere"></div>
		<script src="./js/three.js"></script>
		<script src="./js/D.min.js"></script>
		<script src="./js/uEvent.js"></script>
		<script src="./js/doT.js"></script>
		<script src="./js/CanvasRenderer.js"></script>
		<script src="./js/Projector.js"></script>
		<script src="./js/DeviceOrientationControls.js"></script>
		<script src="./js/view.min.js"></script>
		<div class="szovo">
			<svg version="1.1" id="dc-spinner" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width: "38"="" height: "38"="" viewBox="0 0 38 38" preserveAspectRatio="xMinYMin meet">
				<text x="14" y="21" font-family="Monaco" font-size="2px" style="letter-spacing:0.6" fill="#99cc33">LOADING
     <animate attributeName="opacity" values="0;1;0" dur="1.8s" repeatCount="indefinite"></animate>
  </text>
				<path fill="#373a42" d="M20,35c-8.271,0-15-6.729-15-15S11.729,5,20,5s15,6.729,15,15S28.271,35,20,35z M20,5.203
    C11.841,5.203,5.203,11.841,5.203,20c0,8.159,6.638,14.797,14.797,14.797S34.797,28.159,34.797,20
    C34.797,11.841,28.159,5.203,20,5.203z">
				</path>

				<path fill="#373a42" d="M20,33.125c-7.237,0-13.125-5.888-13.125-13.125S12.763,6.875,20,6.875S33.125,12.763,33.125,20
    S27.237,33.125,20,33.125z M20,7.078C12.875,7.078,7.078,12.875,7.078,20c0,7.125,5.797,12.922,12.922,12.922
    S32.922,27.125,32.922,20C32.922,12.875,27.125,7.078,20,7.078z">
				</path>

				<path fill="#2AA198" stroke="#2AA198" stroke-width="0.6027" stroke-miterlimit="10" d="M5.203,20
			c0-8.159,6.638-14.797,14.797-14.797V5C11.729,5,5,11.729,5,20s6.729,15,15,15v-0.203C11.841,34.797,5.203,28.159,5.203,20z" transform="rotate(7.50829 20 20)">
					<animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" calcMode="spline" keySplines="0.4, 0, 0.2, 1" keyTimes="0;1" dur="2s" repeatCount="indefinite"></animateTransform>
				</path>

				<path fill="#859900" stroke="#859900" stroke-width="0.2027" stroke-miterlimit="10" d="M7.078,20
  c0-7.125,5.797-12.922,12.922-12.922V6.875C12.763,6.875,6.875,12.763,6.875,20S12.763,33.125,20,33.125v-0.203
  C12.875,32.922,7.078,27.125,7.078,20z" transform="rotate(276.329 20 20)">
					<animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1.8s" repeatCount="indefinite"></animateTransform>
				</path>
			</svg>
		</div>
		<script>
		$(function(){
			var panos = [{
				url: './img/jt1_denoise_01.jpg',
				desc: '全景主页',
				target: {
					longitude: 3.848,
					latitude: -0.244
				}
			}, {
				url: './img/jt1_denoise_02.jpg',
				desc: '全景详情',
				target: {
					longitude: 0,
					latitude: 0
				}
			},
			{
				url: './img/jt1_denoise_03.jpg',
				desc: '全景主页',
				target: {
					longitude: 3.848,
					latitude: -0.244
				}
			},
			{
				url: './img/jt1_denoise_04.jpg',
				desc: '全景主页',
				target: {
					longitude: 3.848,
					latitude: -0.244
				}
			},
			{
				url: './img/jt1_denoise_05.jpg',
				desc: '全景主页',
				target: {
					longitude: 3.848,
					latitude: -0.244
				}
			},
			{
				url: './img/jt1_denoise_06.jpg',
				desc: '全景主页',
				target: {
					longitude: 3.848,
					latitude: -0.244
				}
			}
			];
			var isCahe = true;
			var PSV = new PhotoSphereViewer({
				container: 'photosphere',//承载全景图的div盒子
				panorama: panos[0].url,//全景图片的路径
				caption: panos[0].desc,//标题
				time_anim: false,		
				default_long: Math.PI / 2,
				loading_img: '',
				loading_txt: '',
				cache_texture:10,
				//导航栏是一个数组，它可以包含以下核心按钮：自动旋转、缩放、下载、标记、陀螺仪、立体声、全屏，以及用于创建自定义按钮的标题和对象
				navbar: [
					'autorotate', //自动旋转按钮
					'zoom', //放大缩小按钮
					'markers',
					'spacer-1',
					'caption', //显示上面caption参数按钮
					'gyroscope', 
					'fullscreen'//全屏按钮
				],
				anim_speed: "0.6rpm",//自动旋转速度

				//引用自定义的标记
				markers: (function() {
					return common();
				}())
			});
			console.log(PSV),
			PSV.on('ready',function(){//当全景加载完成后再进行操作
				//PSV.toggleAutorotate();////自动播放
				//$('#audios')[0].play(); //是HTML5里新增的 audio播放背景音乐
				$('.szovo').hide();//隐藏
				$('.playBtn').show();//显示音乐播放按钮
			});
			
			PSV.on('select-marker', function(marker) {//当用户单击标记时触发select-marker
				console.log(marker)
				//第一次跳转
				if(marker.data && marker.data.deletable) {
					if(isCahe){
						$('.szovo').show();
						isCahe = false;
					}				
					PSV.clearMarkers();
					// setPanorama参数：图片地址、下一个场景的初始经纬度、transition 默认（false）还可以设置
					PSV.setPanorama(panos[1].url, panos[1].target, true)//重新设置全景图
						.then(function() {
							$('.szovo').hide();//隐藏szovo
							PSV.setCaption(panos[1].desc);
							var len = common1().length;
							for(var k = 0; k < len; k++) {
								PSV.addMarker(common1()[k]);
							}
							PSV.setCaption(panos[1].desc);
						});
						PSV.clearMarkers();//清除所有标记
				}
				//第二次跳转
				if(marker.data && marker.data.deletable1) {
					if(isCahe){
						$('.szovo').show();
						isCahe = false;
					}
					PSV.clearMarkers();//清除所有标记
					PSV.setPanorama(panos[2].url, panos[2].target, true)
						.then(function() {
							$('.szovo').hide();
							PSV.setCaption(panos[2].desc);
							var len = common2().length;
							for(var k = 0; k < len; k++) {
								PSV.addMarker(common2()[k]);
							}
							PSV.setCaption(panos[2].desc);
						});
				}
				//第三次跳转
				if(marker.data && marker.data.deletable2) {
					if(isCahe){
						$('.szovo').show();
						isCahe = false;
					}
					PSV.clearMarkers();//清除所有标记
					PSV.setPanorama(panos[3].url, panos[3].target, true)
						.then(function() {
							$('.szovo').hide();
							PSV.setCaption(panos[2].desc);
							var len = common3().length;
							for(var k = 0; k < len; k++) {
								PSV.addMarker(common3()[k]);
							}
							PSV.setCaption(panos[2].desc);
						});
				}

				//第四次跳转
				if(marker.data && marker.data.deletable3) {
					if(isCahe){
						$('.szovo').show();
						isCahe = false;
					}
					PSV.clearMarkers();//清除所有标记
					PSV.setPanorama(panos[4].url, panos[4].target, true)
						.then(function() {
							$('.szovo').hide();
							PSV.setCaption(panos[2].desc);
							var len = common4().length;
							for(var k = 0; k < len; k++) {
								PSV.addMarker(common4()[k]);
							}
							PSV.setCaption(panos[2].desc);
						});
				}
				//第五次跳转
				if(marker.data && marker.data.deletable4) {
					if(isCahe){
						$('.szovo').show();
						isCahe = false;
					}
					PSV.clearMarkers();//清除所有标记
					PSV.setPanorama(panos[5].url, panos[5].target, true)
						.then(function() {
							$('.szovo').hide();
							PSV.setCaption(panos[2].desc);
							var len = common5().length;
							for(var k = 0; k < len; k++) {
								PSV.addMarker(common5()[k]);
							}
							PSV.setCaption(panos[2].desc);
						});
				}
			});

			$('.playBtn').click(function() {
				if($(this).hasClass('pause')) {
					$(this).removeClass('pause')
					$('#audios')[0].play()
				} else {
					$(this).addClass('pause')
					$('#audios')[0].pause()
				}
			});
			//自定义的按钮
			function common() {
				var a = [];
				a.push({
					id: '#0',
					tooltip: '下一个房间',
					latitude: -0.24,//经纬度   可以使用 x, y替换   代表全景图上的像素坐标
					longitude: 4.12,
					image: './img/go.png',
					width: 60,
					height: 64,
					anchor: 'bottom center',
					data: {
						deletable: true
					},					
				});
				return a
			}

			function common1() {
				var a = [];
				a.push({
					id: '#1',
					tooltip: '第二个房间',
					latitude: -0.29,
					longitude: 4.42,
					image: './img/go.png',
					width: 64,
					height: 64,
					anchor: 'bottom center',
					data: {
						deletable1: true
					},
				});
				a.push({
					id: 'text',
					longitude: -0.048710820324134874,
					latitude: 3.014087667326042,
					html: '床头柜',
					anchor: 'bottom right',
					style: {
						maxWidth: '320px',
						color: '#fff',
						fontSize: '20px',
						fontFamily: 'Helvetica, sans-serif',
						textAlign: 'center'
					},
					tooltip: {
						content: '这里可以放注释',
						position: 'right'
					}
				});
				a.push({
					id: 'circle',
					tooltip: '这是坐窗的坐垫',
					circle: 20,
					svgStyle: {
						fill: 'rgba(255,255,0,0.3)',
						stroke: 'yellow',
						strokeWidth: '2px'
					},
					//						longitude: 0.14842681258549928,
					//						latitude: -0.8678522571819425,
					x: 8395,
					y: 6827,
					anchor: 'center right'
				});
				return a
			}
			function common2() {
				var a = [];
				a.push({
					id: '#2',
					tooltip: '第二个房间',
					latitude: -0.30,//经纬度   可以使用 x, y替换   代表全景图上的像素坐标
					longitude: 2.4,
					image: './img/go.png',
					width: 60,
					height: 64,
					anchor: 'bottom center',
					data: {
						deletable2: true
					},					
				});
				return a
			}
			function common3() {
				var a = [];
				a.push({
					id: '#3',
					tooltip: '第三个房间',
					latitude: -0.23,//经纬度   可以使用 x, y替换   代表全景图上的像素坐标
					longitude: 1.92,
					image: './img/go.png',
					width: 60,
					height: 64,
					anchor: 'bottom center',
					data: {
						deletable3: true
					},					
				});
				return a
			}
			function common4() {
				var a = [];
				a.push({
					id: '#4',
					tooltip: '第三个房间',
					latitude: -0.09,//经纬度   可以使用 x, y替换   代表全景图上的像素坐标
					longitude: 0.48,
					image: './img/go.png',
					width: 60,
					height: 64,
					anchor: 'bottom center',
					data: {
						deletable4: true
					},					
				});
				return a
			}
			function common5() {
				var a = [];
				a.push({
					id: '#5',
					tooltip: '第三个房间',
					latitude: -0.17,//经纬度   可以使用 x, y替换   代表全景图上的像素坐标
					longitude: 0.9,
					image: './img/go.png',
					width: 60,
					height: 64,
					anchor: 'bottom center',
					data: {
						deletable5: true
					},					
				});
				return a
			}
			
			function transToThreeCoord(x, y) {
				let mouse = new THREE.Vector3();
				mouse.x = (x / 14620) * 2 - 1;
				mouse.y = -(y / 7310) * 2 + 1;
				return mouse;
			}

			/**
			 * 当用户点击某个地方时，创建一个新的标记，获取经纬度
			 */
			PSV.on('click', function (e) {
				// PSV.addMarker({
				// 	id: '#' + Math.random(),
				// 	longitude: e.longitude,
				// 	latitude: e.latitude,
				// 	image: 'http://photo-sphere-viewer.js.org/assets/pin-red.png',
				// 	width: 32,
				// 	height: 32,
				// 	anchor: 'bottom center',
				// 	tooltip: 'Generated pin',
				// 	data: {
				// 		generated: true
				// 	}
				// });
				console.log(e.longitude,e.latitude)
			});
		})
		</script>

	</body>

</html>